<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bingo Card Maker - Pro Edition</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#764ba2">
  <style>
    :root {
      --cell-height: 60px;
      --card-spacing: 5mm;
      --paper-size: a4;
      --top-print-margin: 1.0cm;
      --page-horizontal-margin: 1cm;
      --bingo-font-size: 14pt;
      --bingo-font-family: inherit;
      --color-card: #28a745; /* Green */
      --color-call: #dc3545; /* Red */
      --color-off: #cbd5e0;  /* Gray */
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 10px;
    }

    .container {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      max-width: 800px;
      width: 100%;
      box-sizing: border-box;
      position: relative;
    }

    h2 { color: #4a5568; text-align: center; margin-bottom: 25px; font-size: 28px; }

    .template-section { margin: 20px 0; padding: 15px; background: #fff8dc; border-radius: 8px; border: 2px solid #f0e68c; }
    .wordlist-group { display: flex; align-items: center; gap: 5px; margin-bottom: 5px; }
    
    textarea {
      width: 100%; height: 160px; resize: vertical; padding: 12px; font-size: 14px;
      box-sizing: border-box; border: 2px solid #e2e8f0; border-radius: 8px;
    }

    #modeLegend {
      display: none; border: 2px solid #cbd5e0; border-radius: 10px; 
      padding: 15px; margin: 15px 0; background: #fdfdfd; 
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); text-align: center;
    }
    .legend-items { font-size: 20px; font-weight: bold; margin-bottom: 5px; }
    .legend-key { font-size: 11px; color: #718096; }

    .input-group { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
    .input-group label { display: block; margin-bottom: 4px; font-weight: 600; color: #4a5568; }
    .input-group select, .input-group input { margin-top: 4px; padding: 8px; border-radius: 6px; border: 1px solid #cbd5e0; width: 100%; box-sizing: border-box; }

    .button-row { display: flex; gap: 10px; margin-top: 15px; }
    button {
      width: 100%; padding: 12px; margin-top: 10px; font-size: 16px; font-weight: 600;
      color: white; border: none; border-radius: 8px; cursor: pointer; transition: transform 0.1s;
    }
    button:active { transform: scale(0.98); }
.load-btn { 
  flex: 3; 
  background: #fd7e14; 
  margin-top: 0; 
  overflow: hidden; 
  text-overflow: ellipsis; 
  white-space: nowrap; 
  height: 40px; /* Forces uniform height */
  line-height: 1;
}

.save-slot-btn { 
  flex: 1; 
  background: #4CAF50 !important; 
  margin-top: 0; 
  font-size: 14px; /* Increased to match other buttons */
  height: 40px; 
  line-height: 1;
}

.clear-btn { 
  flex: 0.3; 
  background: #dc !important; /* Was previously colour #dc3545 */
  margin-top: 0; 
  height: 40px; 
  line-height: 1;
  padding: 0; /* Prevents padding from inflating the box */
}
    .generate-btn { background: #4CAF50; }
    .print-btn { background: #2196F3; }
    .settings-btn { background: #718096; }

    #previewModal, #settingsModal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); z-index: 2000; overflow-y: auto; padding: 20px;
      box-sizing: border-box;
    }
    .modal-content {
      background: white; margin: 40px auto; padding: 25px; border-radius: 15px;
      max-width: 550px; width: 100%; position: relative; box-sizing: border-box;
    }
    #previewModal .modal-content { max-width: 850px; }

    .bingo-card {
      display: grid; border: 2pt solid #000; background: white; margin-bottom: var(--card-spacing);
      page-break-inside: avoid; width: 100%; box-sizing: border-box;
    }
    .bingo-cell {
      border: 1pt solid #000; display: flex; align-items: center; justify-content: center;
      text-align: center; height: var(--cell-height); font-size: var(--bingo-font-size);
      font-family: var(--bingo-font-family); padding: 5px; word-break: break-word; box-sizing: border-box;
    }

    .call-list-item { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; border-bottom: 1px solid #eee; padding: 5px; }
    .checkbox-group { display: flex; gap: 4px; }
    .checkbox-group input { width: 18px; height: 18px; }

    /* Print-Only Call List Two Column Logic */
    .call-list-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

    #printBuffer { display: none; }

    @media print {
      .no-print, #previewModal, #settingsModal { display: none !important; }
      #printBuffer { display: block !important; }
      body { background: white; display: block; }
      .container { display: none; }
      @page { size: var(--paper-size); margin: var(--top-print-margin) var(--page-horizontal-margin); }
      .call-list-container { page-break-before: always; }
    }
  </style>
</head>
<body>

  <div class="container no-print">
    <h2>üìÑ Multilingual Bingo Card Maker</h2>
    
    <div class="template-section">
      <div style="font-weight:600; color:#b8860b; margin-bottom:10px;">üíæ Wordlist Manager</div>
      <div class="wordlist-group">
        <button id="load1" class="load-btn">Slot 1 (Empty)</button>
        <button onclick="saveToSlot(1)" class="save-slot-btn">üíæ Save</button>
        <button onclick="clearSlot(1)" class="clear-btn">‚ùå</button>
      </div>
      <div class="wordlist-group">
        <button id="load2" class="load-btn">Slot 2 (Empty)</button>
        <button onclick="saveToSlot(2)" class="save-slot-btn">üíæ Save</button>
        <button onclick="clearSlot(2)" class="clear-btn">‚ùå</button>
      </div>
      <div class="wordlist-group">
        <button id="load3" class="load-btn">Slot 3 (Empty)</button>
        <button onclick="saveToSlot(3)" class="save-slot-btn">üíæ Save</button>
        <button onclick="clearSlot(3)" class="clear-btn">‚ùå</button>
      </div>
    </div>

    <textarea id="wordInput" oninput="updateWordCount()" placeholder="Apple = Manzana&#10;Banana = Pl√°tano..."></textarea>
    
    <div id="modeLegend">
      <div class="legend-items" id="legendItems"></div>
      <div class="legend-key">
        (<span style="color: var(--color-card)">‚óè</span> Card Content | <span style="color: var(--color-call)">‚óè</span> Teacher Call)
      </div>
    </div>

    <div id="wordCountLabel" style="font-size:12px; color:#666; margin-top:5px;">0 words entered</div>

    <div class="input-group">
      <div>
        <label>Grid Size:</label>
        <select id="gridSize">
          <option value="3">3 x 3</option>
          <option value="4" selected>4 x 4</option>
          <option value="5">5 x 5</option>
        </select>
      </div>
      <div>
        <label>Number of Cards:</label>
        <input type="number" id="numCards" value="10" min="1" max="100">
      </div>
    </div>

    <div class="button-row" id="langButtons" style="display:none;">
      <button onclick="toggleBilingual()" style="background:#FF9800;">‚ÜîÔ∏è Swap Lang</button>
      <button onclick="toggleMonolingual()" style="background:#9C27B0;">‚û°Ô∏è Monolingual Mode</button>
    </div>

    <button onclick="generateCards(true)" class="generate-btn">üé≤ Generate & Preview</button>
    <button onclick="handlePrint()" class="print-btn">üñ®Ô∏è Print Everything</button>
    <button onclick="showSettings()" class="settings-btn">‚öôÔ∏è Advanced Settings</button>
  </div>

  <div id="previewModal">
    <div class="modal-content">
      <button onclick="closeModal('previewModal')" style="background:#333; width:auto; float:right; padding: 5px 15px;">Close</button>
      <h3>Preview: Generated Cards</h3>
      <div id="previewArea"></div>
    </div>
  </div>

  <div id="settingsModal">
    <div class="modal-content">
      <h3 style="margin-top:0;">‚öôÔ∏è Advanced Settings</h3>
      <div class="input-group">
        <div><label>Font Size (pt):</label><input type="number" id="optFontSize" value="14"></div>
        <div><label>Cell Height (px):</label><input type="number" id="optCellHeight" value="60"></div>
        <div><label>Spacing (mm):</label><input type="number" id="optSpacing" value="5"></div>
        <div><label>Paper Size:</label><select id="optPaper"><option value="a4">A4</option><option value="letter">Letter</option></select></div>
      </div>
      <div class="input-group">
          <div style="grid-column: span 2;">
            <label>Custom System Font:</label>
            <input type="text" id="optFontFamily" placeholder="e.g. Andika, Calibri">
          </div>
      </div>
      <button onclick="applySettings()" style="background:#4CAF50;">Apply Settings</button>
    </div>
  </div>

  <div id="printBuffer"></div>

  <script>
    let appMode = 'bilingual', subMode = 'primary';
    let wordData = { left: [], right: [] };
    let cardsGenerated = false;

    window.onload = updateSlotButtons;

    function updateWordCount() {
      const inputVal = document.getElementById('wordInput').value;
      const lines = inputVal.split(/[\n,]+/).map(s => s.trim()).filter(s => s);
      const isMulti = lines.some(l => l.includes('='));
      
      document.getElementById('wordCountLabel').innerText = `${lines.length} items entered.`;
      document.getElementById('langButtons').style.display = isMulti ? 'flex' : 'none';
      
      if (isMulti) {
        wordData.left = lines.map(l => l.split('=')[0]?.trim());
        wordData.right = lines.map(l => l.split('=')[1]?.trim());
        document.getElementById('modeLegend').style.display = 'block';
        updateLegend();
      } else {
        wordData.left = lines;
        wordData.right = [];
        appMode = 'single';
        document.getElementById('modeLegend').style.display = 'none';
      }
      cardsGenerated = false;
    }

    function updateLegend() {
      const legend = document.getElementById('legendItems');
      let lCol, rCol;

      if (appMode === 'bilingual') {
        lCol = subMode === 'primary' ? 'var(--color-card)' : 'var(--color-call)';
        rCol = subMode === 'primary' ? 'var(--color-call)' : 'var(--color-card)';
      } else {
        lCol = subMode === 'primary' ? 'var(--color-card)' : 'var(--color-off)';
        rCol = subMode === 'primary' ? 'var(--color-off)' : 'var(--color-card)';
      }

      legend.innerHTML = `
        <span style="color: ${lCol}">Apple</span> 
        <span style="color: #4a5568"> = </span> 
        <span style="color: ${rCol}">Manzana</span>
      `;
    }

    function generateCards(showModal = false) {
      updateWordCount();
      const size = parseInt(document.getElementById('gridSize').value);
      const count = parseInt(document.getElementById('numCards').value);
      const req = size * size;
      
      let cardPool, callPool;

      if (wordData.right.length > 0) {
        if (appMode === 'bilingual') {
          cardPool = subMode === 'primary' ? wordData.left : wordData.right;
          callPool = subMode === 'primary' ? wordData.right : wordData.left;
        } else {
          cardPool = subMode === 'primary' ? wordData.left : wordData.right;
          callPool = cardPool;
        }
      } else {
        cardPool = callPool = wordData.left;
      }

      if (cardPool.length < req) return alert(`Need at least ${req} unique words!`);

      const buffer = document.getElementById('printBuffer');
      const preview = document.getElementById('previewArea');
      buffer.innerHTML = preview.innerHTML = "";

      // Truncated Preview Container
      const previewContainer = document.createElement('div');
      previewContainer.style.maxHeight = "500px";
      previewContainer.style.overflow = "hidden";
      previewContainer.style.position = "relative";
      previewContainer.style.border = "1px solid #eee";
      previewContainer.style.padding = "10px";

      for (let i = 0; i < count; i++) {
        const shuffled = [...cardPool].sort(() => 0.5 - Math.random()).slice(0, req);
        const card = document.createElement('div');
        card.className = 'bingo-card';
        card.style.gridTemplateColumns = `repeat(${size}, 1fr)`;
        shuffled.forEach(w => {
          const cell = document.createElement('div');
          cell.className = 'bingo-cell';
          cell.innerText = w;
          card.appendChild(cell);
        });

        buffer.appendChild(card.cloneNode(true));
        if (i < 2) previewContainer.appendChild(card);
      }

      const fade = document.createElement('div');
      fade.style.position = "absolute"; fade.style.bottom = "0"; fade.style.left = "0";
      fade.style.width = "100%"; fade.style.height = "80px";
      fade.style.background = "linear-gradient(transparent, white)";
      fade.style.pointerEvents = "none";
      previewContainer.appendChild(fade);
      preview.appendChild(previewContainer);

      // Create Call List
      const callListContainer = document.createElement('div');
      callListContainer.className = 'call-list-container';
      callListContainer.innerHTML = "<h2 style='text-align:center;'>Call List</h2>";
      
      const grid = document.createElement('div');
      grid.className = 'call-list-grid';
      
      const items = [...new Set(callPool)].sort();
      items.forEach(w => {
        grid.innerHTML += `<div class="call-list-item"><div class="checkbox-group">${'<input type="checkbox">'.repeat(5)}</div><span>${w}</span></div>`;
      });
      callListContainer.appendChild(grid);

      buffer.appendChild(callListContainer.cloneNode(true));

      // Truncated Modal Call List Preview
      const callPreview = callListContainer.cloneNode(true);
      callPreview.style.opacity = "0.5";
      callPreview.style.maxHeight = "150px";
      callPreview.style.overflow = "hidden";
      callPreview.style.marginTop = "20px";
      callPreview.style.borderTop = "2px dashed #ccc";
      preview.appendChild(callPreview);

      cardsGenerated = true;
      if(showModal) document.getElementById('previewModal').style.display = 'block';
    }

    function handlePrint() {
      if (!cardsGenerated) return alert("Please click 'Generate & Preview' first!");
      window.print();
    }

    function toggleBilingual() { appMode = 'bilingual'; subMode = subMode === 'primary' ? 'secondary' : 'primary'; updateLegend(); generateCards(false); }
    function toggleMonolingual() { appMode = 'monolingual'; subMode = subMode === 'primary' ? 'secondary' : 'primary'; updateLegend(); generateCards(false); }

    function saveToSlot(id) {
      const content = document.getElementById('wordInput').value;
      if (!content.trim()) return;
      const name = prompt("Name this wordlist:", localStorage.getItem('bingo_name_'+id) || "List " + id);
      if (name) { localStorage.setItem('bingo_data_'+id, content); localStorage.setItem('bingo_name_'+id, name); updateSlotButtons(); }
    }

    function clearSlot(id) { if(confirm("Clear slot " + id + "?")) { localStorage.removeItem('bingo_data_'+id); localStorage.removeItem('bingo_name_'+id); updateSlotButtons(); } }

    function updateSlotButtons() {
      for(let i=1; i<=3; i++) {
        const name = localStorage.getItem('bingo_name_'+i) || `Slot ${i} (Empty)`;
        const btn = document.getElementById('load'+i);
        btn.innerText = name;
        btn.onclick = () => {
          const data = localStorage.getItem('bingo_data_'+i);
          if (data) { document.getElementById('wordInput').value = data; updateWordCount(); }
        };
      }
    }

    function showSettings() { document.getElementById('settingsModal').style.display = 'block'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function applySettings() {
      const root = document.documentElement;
      root.style.setProperty('--bingo-font-size', document.getElementById('optFontSize').value + 'pt');
      root.style.setProperty('--cell-height', document.getElementById('optCellHeight').value + 'px');
      root.style.setProperty('--card-spacing', document.getElementById('optSpacing').value + 'mm');
      root.style.setProperty('--paper-size', document.getElementById('optPaper').value);
      root.style.setProperty('--bingo-font-family', document.getElementById('optFontFamily').value || 'inherit');
      closeModal('settingsModal');
    }
  </script>
  <script>
  // PWA Registration Script
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js');
  }

  // Optional: Automatic Install Prompt on load
  let deferredPrompt;
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    // Show the prompt after 3 seconds of use
    setTimeout(() => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
      }
    }, 3000);
  });
</script>
</body>
</html>
